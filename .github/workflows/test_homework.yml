name: Run Homework Tests

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, edited, synchronize, ready_for_review]
    branches: [main]

jobs:
  validate-homework:
    if: ${{ github.event.pull_request.number != 1 }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Extract HW number from PR title
        id: extract_hw
        run: |
          echo "PR title: ${{ github.event.pull_request.title }}"
          if [[ "${{ github.event.pull_request.title }}" =~ Homework([0-9]+) ]]; then
            echo "Found homework number: ${BASH_REMATCH[1]}"
            echo "num=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
            echo "test_file=tests/test_hw${BASH_REMATCH[1]}.py" >> $GITHUB_OUTPUT
            echo "hw_dir=homeworks/hw${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
            echo "No HW number found in PR title."
            exit 1
          fi

      - name: Run homework-specific tests
        run: pytest ${{ steps.extract_hw.outputs.test_file }} -v --tb=short --disable-warnings